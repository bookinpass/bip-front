/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Util } from '../../../misc/util/internal';
/**
 * @record
 * @template T
 */
function ICachedArray() { }
/**
 * @template T, U
 */
var /**
 * @template T, U
 */
SearchService = /** @class */ (function () {
    function SearchService(allowEmptyQuery) {
        var _this = this;
        if (allowEmptyQuery === void 0) { allowEmptyQuery = false; }
        this._options = [];
        this.optionsFilter = (/**
         * @param {?} os
         * @param {?} q
         * @return {?}
         */
        function (os, q) {
            // Convert the query string to a RegExp.
            /** @type {?} */
            var regex = _this.toRegex(_this._query);
            if (regex instanceof RegExp) {
                // Only update the results if the query was valid regex.
                // This avoids the results suddenly becoming empty if an invalid regex string is inputted.
                return os
                    // Filter on the options with a string match on the field we are testing.
                    .filter((/**
                 * @param {?} o
                 * @return {?}
                 */
                function (o) { return Util.Object.readValue(o, _this._optionsField)
                    .toString()
                    .match(regex); }));
            }
            // Don't update since it wasn't a valid regex.
            return false;
        });
        // Set default values and reset.
        this.allowEmptyQuery = allowEmptyQuery;
        this.searchDelay = 0;
        this.reset();
    }
    Object.defineProperty(SearchService.prototype, "hasItemLookup", {
        get: /**
         * @return {?}
         */
        function () {
            return !!this.optionsLookup && this.optionsLookup.length === 2;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SearchService.prototype, "options", {
        get: /**
         * @return {?}
         */
        function () {
            return this._options;
        },
        set: /**
         * @param {?} options
         * @return {?}
         */
        function (options) {
            this._options = options || [];
            // We cannot use both local & remote options simultaneously.
            this._optionsLookup = undefined;
            // Reset entire service with new options.
            this.reset();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SearchService.prototype, "optionsLookup", {
        get: /**
         * @return {?}
         */
        function () {
            return this._optionsLookup;
        },
        set: /**
         * @param {?} lookupFn
         * @return {?}
         */
        function (lookupFn) {
            this._optionsLookup = lookupFn;
            // As before, cannot use local & remote options simultaneously.
            this._options = [];
            this.reset();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SearchService.prototype, "optionsField", {
        get: /**
         * @return {?}
         */
        function () {
            return this._optionsField;
        },
        set: /**
         * @param {?} field
         * @return {?}
         */
        function (field) {
            this._optionsField = field;
            // We need to reset otherwise we would now be showing invalid search results.
            this.reset();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SearchService.prototype, "results", {
        get: /**
         * @return {?}
         */
        function () {
            return this._results;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SearchService.prototype, "query", {
        get: /**
         * @return {?}
         */
        function () {
            return this._query;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SearchService.prototype, "isSearching", {
        get: /**
         * @return {?}
         */
        function () {
            return this._isSearching;
        },
        enumerable: true,
        configurable: true
    });
    // Updates the query after the specified search delay.
    // Updates the query after the specified search delay.
    /**
     * @param {?} query
     * @param {?=} callback
     * @return {?}
     */
    SearchService.prototype.updateQueryDelayed = 
    // Updates the query after the specified search delay.
    /**
     * @param {?} query
     * @param {?=} callback
     * @return {?}
     */
    function (query, callback) {
        var _this = this;
        if (callback === void 0) { callback = (/**
         * @return {?}
         */
        function () {
        }); }
        this._query = query;
        clearTimeout(this._searchDelayTimeout);
        this._searchDelayTimeout = window.setTimeout((/**
         * @return {?}
         */
        function () {
            _this.updateQuery(query, callback);
        }), this.searchDelay);
    };
    // Updates the current search query.
    // Updates the current search query.
    /**
     * @param {?} query
     * @param {?=} callback
     * @return {?}
     */
    SearchService.prototype.updateQuery = 
    // Updates the current search query.
    /**
     * @param {?} query
     * @param {?=} callback
     * @return {?}
     */
    function (query, callback) {
        var _this = this;
        if (callback === void 0) { callback = (/**
         * @return {?}
         */
        function () {
        }); }
        this._query = query;
        if (this._query === '' && !this.allowEmptyQuery) {
            // Don't update if the new query is empty (and we don't allow empty queries).
            // Don't reset so that when animating closed we don't get a judder.
            return callback();
        }
        if (this._resultsCache.hasOwnProperty(this._query)) {
            // If the query is already cached, make use of it.
            this._results = this._resultsCache[this._query];
            return callback();
        }
        if (this._optionsLookup) {
            this._isSearching = true;
            // Call the options lookup without a this context.
            /** @type {?} */
            var queryLookup = (/** @type {?} */ (this._optionsLookup.call(undefined, this._query)));
            queryLookup
                .then((/**
             * @param {?} results
             * @return {?}
             */
            function (results) {
                _this._isSearching = false;
                _this.updateResults(results);
                return callback();
            }))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                // Unset 'loading' state, and throw the returned error without updating the results.
                _this._isSearching = false;
                return callback(error);
            }));
            return;
        }
        /** @type {?} */
        var filtered = this.optionsFilter.call(undefined, this._options, this._query);
        if (filtered) {
            this.updateResults(filtered);
        }
        return callback();
    };
    // tslint:disable-next-line:promise-function-async
    // tslint:disable-next-line:promise-function-async
    /**
     * @param {?} initial
     * @return {?}
     */
    SearchService.prototype.initialLookup = 
    // tslint:disable-next-line:promise-function-async
    /**
     * @param {?} initial
     * @return {?}
     */
    function (initial) {
        if (initial instanceof Array) {
            return (/** @type {?} */ (((/** @type {?} */ ((/** @type {?} */ (this._optionsLookup)))))(undefined, initial)));
        }
        return (/** @type {?} */ (((/** @type {?} */ ((/** @type {?} */ (this._optionsLookup)))))(undefined, initial)));
    };
    // Generates HTML for highlighted match text.
    // Generates HTML for highlighted match text.
    /**
     * @param {?} text
     * @param {?} query
     * @return {?}
     */
    SearchService.prototype.highlightMatches = 
    // Generates HTML for highlighted match text.
    /**
     * @param {?} text
     * @param {?} query
     * @return {?}
     */
    function (text, query) {
        /** @type {?} */
        var regex = this.toRegex(query);
        if (regex instanceof RegExp) {
            return text.replace(regex, (/**
             * @param {?} match
             * @return {?}
             */
            function (match) { return "<b>" + match + "</b>"; }));
        }
        return text;
    };
    // Updates & caches the new set of results.
    // Updates & caches the new set of results.
    /**
     * @private
     * @param {?} results
     * @return {?}
     */
    SearchService.prototype.updateResults = 
    // Updates & caches the new set of results.
    /**
     * @private
     * @param {?} results
     * @return {?}
     */
    function (results) {
        this._resultsCache[this._query] = results;
        this._results = results;
    };
    // Converts a query string to regex without throwing an error.
    // Converts a query string to regex without throwing an error.
    /**
     * @private
     * @param {?} query
     * @return {?}
     */
    SearchService.prototype.toRegex = 
    // Converts a query string to regex without throwing an error.
    /**
     * @private
     * @param {?} query
     * @return {?}
     */
    function (query) {
        try {
            return new RegExp(query, 'i');
        }
        catch (e) {
            return query;
        }
    };
    // Resets the search back to a pristine state.
    // Resets the search back to a pristine state.
    /**
     * @private
     * @return {?}
     */
    SearchService.prototype.reset = 
    // Resets the search back to a pristine state.
    /**
     * @private
     * @return {?}
     */
    function () {
        this._results = [];
        this._resultsCache = {};
        this._isSearching = false;
        this.updateQuery('');
    };
    return SearchService;
}());
/**
 * @template T, U
 */
export { SearchService };
if (false) {
    /** @type {?} */
    SearchService.prototype.optionsFilter;
    /** @type {?} */
    SearchService.prototype.allowEmptyQuery;
    /** @type {?} */
    SearchService.prototype.searchDelay;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._resultsCache;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._searchDelayTimeout;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._options;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._optionsLookup;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._optionsField;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._results;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._query;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._isSearching;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtZm9tYW50aWMtdWkvIiwic291cmNlcyI6WyJtb2R1bGVzL3NlYXJjaC9zZXJ2aWNlcy9zZWFyY2guc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLDZCQUE2QixDQUFDOzs7OztBQUdqRCwyQkFFQzs7OztBQUVEOzs7O0lBYUUsdUJBQVksZUFBZ0M7UUFBNUMsaUJBd0JDO1FBeEJXLGdDQUFBLEVBQUEsdUJBQWdDO1FBQzFDLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxhQUFhOzs7OztRQUFHLFVBQUMsRUFBRSxFQUFFLENBQUM7OztnQkFFbkIsS0FBSyxHQUFHLEtBQUksQ0FBQyxPQUFPLENBQUMsS0FBSSxDQUFDLE1BQU0sQ0FBQztZQUV2QyxJQUFJLEtBQUssWUFBWSxNQUFNLEVBQUU7Z0JBQzNCLHdEQUF3RDtnQkFDeEQsMEZBQTBGO2dCQUMxRixPQUFPLEVBQUU7b0JBQ1QseUVBQXlFO3FCQUN0RSxNQUFNOzs7O2dCQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQVksQ0FBQyxFQUFFLEtBQUksQ0FBQyxhQUFhLENBQUM7cUJBQ2pFLFFBQVEsRUFBRTtxQkFDVixLQUFLLENBQUMsS0FBSyxDQUFDLEVBRkYsQ0FFRSxFQUFDLENBQUM7YUFDcEI7WUFFRCw4Q0FBOEM7WUFDOUMsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDLENBQUEsQ0FBQztRQUVGLGdDQUFnQztRQUNoQyxJQUFJLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQztRQUN2QyxJQUFJLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQztRQUNyQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDZixDQUFDO0lBRUQsc0JBQVcsd0NBQWE7Ozs7UUFBeEI7WUFDRSxPQUFP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O0lBRWxDLHdDQUFnQzs7SUFFaEMsb0NBQTJCOzs7OztJQUUzQixzQ0FBdUM7Ozs7O0lBRXZDLDRDQUFvQzs7Ozs7SUFpQ3BDLGlDQUFzQjs7Ozs7SUFldEIsdUNBQXdDOzs7OztJQWN4QyxzQ0FBK0I7Ozs7O0lBYS9CLGlDQUFzQjs7Ozs7SUFNdEIsK0JBQXVCOzs7OztJQU92QixxQ0FBOEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1V0aWx9IGZyb20gJy4uLy4uLy4uL21pc2MvdXRpbC9pbnRlcm5hbCc7XHJcbmltcG9ydCB7RmlsdGVyRm4sIExvb2t1cEZuLCBMb29rdXBGblJlc3VsdH0gZnJvbSAnLi4vaGVscGVycy9sb29rdXAtZm4nO1xyXG5cclxuaW50ZXJmYWNlIElDYWNoZWRBcnJheTxUPiB7XHJcbiAgW3F1ZXJ5OiBzdHJpbmddOiBUW107XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBTZWFyY2hTZXJ2aWNlPFQsIFU+IHtcclxuXHJcbiAgLy8gRmlsdGVycyBhIGxpc3Qgb2Ygb3B0aW9ucy5cclxuICBwdWJsaWMgb3B0aW9uc0ZpbHRlcjogRmlsdGVyRm48VD47XHJcbiAgLy8gQWxsb3dzIHRoZSBlbXB0eSBxdWVyeSB0byBwcm9kdWNlIHJlc3VsdHMuXHJcbiAgcHVibGljIGFsbG93RW1wdHlRdWVyeTogYm9vbGVhbjtcclxuICAvLyBIb3cgbG9uZyB0byBkZWxheSB0aGUgc2VhcmNoIGZvciB3aGVuIHVzaW5nIHVwZGF0ZVF1ZXJ5RGVsYXllZC4gU3RvcmVkIGluIG1zLlxyXG4gIHB1YmxpYyBzZWFyY2hEZWxheTogbnVtYmVyO1xyXG4gIC8vIENhY2hlIG9mIHJlc3VsdHMsIGluZGV4ZWQgYnkgcXVlcnkuXHJcbiAgcHJpdmF0ZSBfcmVzdWx0c0NhY2hlOiBJQ2FjaGVkQXJyYXk8VD47XHJcbiAgLy8gU3RvcmVzIHRoZSBzZWFyY2ggdGltZW91dCBoYW5kbGUgc28gd2UgY2FuIGNhbmNlbCBpdC5cclxuICBwcml2YXRlIF9zZWFyY2hEZWxheVRpbWVvdXQ6IG51bWJlcjtcclxuXHJcbiAgY29uc3RydWN0b3IoYWxsb3dFbXB0eVF1ZXJ5OiBib29sZWFuID0gZmFsc2UpIHtcclxuICAgIHRoaXMuX29wdGlvbnMgPSBbXTtcclxuICAgIHRoaXMub3B0aW9uc0ZpbHRlciA9IChvcywgcSkgPT4ge1xyXG4gICAgICAvLyBDb252ZXJ0IHRoZSBxdWVyeSBzdHJpbmcgdG8gYSBSZWdFeHAuXHJcbiAgICAgIGNvbnN0IHJlZ2V4ID0gdGhpcy50b1JlZ2V4KHRoaXMuX3F1ZXJ5KTtcclxuXHJcbiAgICAgIGlmIChyZWdleCBpbnN0YW5jZW9mIFJlZ0V4cCkge1xyXG4gICAgICAgIC8vIE9ubHkgdXBkYXRlIHRoZSByZXN1bHRzIGlmIHRoZSBxdWVyeSB3YXMgdmFsaWQgcmVnZXguXHJcbiAgICAgICAgLy8gVGhpcyBhdm9pZHMgdGhlIHJlc3VsdHMgc3VkZGVubHkgYmVjb21pbmcgZW1wdHkgaWYgYW4gaW52YWxpZCByZWdleCBzdHJpbmcgaXMgaW5wdXR0ZWQuXHJcbiAgICAgICAgcmV0dXJuIG9zXHJcbiAgICAgICAgLy8gRmlsdGVyIG9uIHRoZSBvcHRpb25zIHdpdGggYSBzdHJpbmcgbWF0Y2ggb24gdGhlIGZpZWxkIHdlIGFyZSB0ZXN0aW5nLlxyXG4gICAgICAgICAgLmZpbHRlcihvID0+IFV0aWwuT2JqZWN0LnJlYWRWYWx1ZTxULCBzdHJpbmc+KG8sIHRoaXMuX29wdGlvbnNGaWVsZClcclxuICAgICAgICAgICAgLnRvU3RyaW5nKClcclxuICAgICAgICAgICAgLm1hdGNoKHJlZ2V4KSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIERvbid0IHVwZGF0ZSBzaW5jZSBpdCB3YXNuJ3QgYSB2YWxpZCByZWdleC5cclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBTZXQgZGVmYXVsdCB2YWx1ZXMgYW5kIHJlc2V0LlxyXG4gICAgdGhpcy5hbGxvd0VtcHR5UXVlcnkgPSBhbGxvd0VtcHR5UXVlcnk7XHJcbiAgICB0aGlzLnNlYXJjaERlbGF5ID0gMDtcclxuICAgIHRoaXMucmVzZXQoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXQgaGFzSXRlbUxvb2t1cCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAhIXRoaXMub3B0aW9uc0xvb2t1cCAmJiB0aGlzLm9wdGlvbnNMb29rdXAubGVuZ3RoID09PSAyO1xyXG4gIH1cclxuXHJcbiAgLy8gU3RvcmVzIHRoZSBhdmFpbGFibGUgb3B0aW9ucy5cclxuICBwcml2YXRlIF9vcHRpb25zOiBUW107XHJcblxyXG4gIHB1YmxpYyBnZXQgb3B0aW9ucygpOiBUW10ge1xyXG4gICAgcmV0dXJuIHRoaXMuX29wdGlvbnM7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2V0IG9wdGlvbnMob3B0aW9uczogVFtdKSB7XHJcbiAgICB0aGlzLl9vcHRpb25zID0gb3B0aW9ucyB8fCBbXTtcclxuICAgIC8vIFdlIGNhbm5vdCB1c2UgYm90aCBsb2NhbCAmIHJlbW90ZSBvcHRpb25zIHNpbXVsdGFuZW91c2x5LlxyXG4gICAgdGhpcy5fb3B0aW9uc0xvb2t1cCA9IHVuZGVmaW5lZDtcclxuICAgIC8vIFJlc2V0IGVudGlyZSBzZXJ2aWNlIHdpdGggbmV3IG9wdGlvbnMuXHJcbiAgICB0aGlzLnJlc2V0KCk7XHJcbiAgfVxyXG5cclxuICAvLyBDb252ZXJ0cyBhIHF1ZXJ5IHN0cmluZyBpbnRvIGFuIGFycmF5IG9mIG9wdGlvbnMuIE11c3QgYmUgYSBmdW5jdGlvbiByZXR1cm5pbmcgYSBwcm9taXNlLlxyXG4gIHByaXZhdGUgX29wdGlvbnNMb29rdXA/OiBMb29rdXBGbjxULCBVPjtcclxuXHJcbiAgcHVibGljIGdldCBvcHRpb25zTG9va3VwKCk6IExvb2t1cEZuPFQsIFU+IHwgdW5kZWZpbmVkIHtcclxuICAgIHJldHVybiB0aGlzLl9vcHRpb25zTG9va3VwO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNldCBvcHRpb25zTG9va3VwKGxvb2t1cEZuOiBMb29rdXBGbjxULCBVPiB8IHVuZGVmaW5lZCkge1xyXG4gICAgdGhpcy5fb3B0aW9uc0xvb2t1cCA9IGxvb2t1cEZuO1xyXG4gICAgLy8gQXMgYmVmb3JlLCBjYW5ub3QgdXNlIGxvY2FsICYgcmVtb3RlIG9wdGlvbnMgc2ltdWx0YW5lb3VzbHkuXHJcbiAgICB0aGlzLl9vcHRpb25zID0gW107XHJcbiAgICB0aGlzLnJlc2V0KCk7XHJcbiAgfVxyXG5cclxuICAvLyBGaWVsZCB0aGF0IG9wdGlvbnMgYXJlIHNlYXJjaGVkICYgZGlzcGxheWVkIG9uLlxyXG4gIHByaXZhdGUgX29wdGlvbnNGaWVsZD86IHN0cmluZztcclxuXHJcbiAgcHVibGljIGdldCBvcHRpb25zRmllbGQoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcclxuICAgIHJldHVybiB0aGlzLl9vcHRpb25zRmllbGQ7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2V0IG9wdGlvbnNGaWVsZChmaWVsZDogc3RyaW5nIHwgdW5kZWZpbmVkKSB7XHJcbiAgICB0aGlzLl9vcHRpb25zRmllbGQgPSBmaWVsZDtcclxuICAgIC8vIFdlIG5lZWQgdG8gcmVzZXQgb3RoZXJ3aXNlIHdlIHdvdWxkIG5vdyBiZSBzaG93aW5nIGludmFsaWQgc2VhcmNoIHJlc3VsdHMuXHJcbiAgICB0aGlzLnJlc2V0KCk7XHJcbiAgfVxyXG5cclxuICAvLyBTdG9yZXMgdGhlIHJlc3VsdHMgb2YgdGhlIHF1ZXJ5LlxyXG4gIHByaXZhdGUgX3Jlc3VsdHM6IFRbXTtcclxuXHJcbiAgcHVibGljIGdldCByZXN1bHRzKCk6IFRbXSB7XHJcbiAgICByZXR1cm4gdGhpcy5fcmVzdWx0cztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX3F1ZXJ5OiBzdHJpbmc7XHJcblxyXG4gIHB1YmxpYyBnZXQgcXVlcnkoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLl9xdWVyeTtcclxuICB9XHJcblxyXG4gIC8vIFByb3ZpZGVzICdsb2FkaW5nJyBmdW5jdGlvbmFsaXR5LlxyXG4gIHByaXZhdGUgX2lzU2VhcmNoaW5nOiBib29sZWFuO1xyXG5cclxuICBwdWJsaWMgZ2V0IGlzU2VhcmNoaW5nKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX2lzU2VhcmNoaW5nO1xyXG4gIH1cclxuXHJcbiAgLy8gVXBkYXRlcyB0aGUgcXVlcnkgYWZ0ZXIgdGhlIHNwZWNpZmllZCBzZWFyY2ggZGVsYXkuXHJcbiAgcHVibGljIHVwZGF0ZVF1ZXJ5RGVsYXllZChxdWVyeTogc3RyaW5nLCBjYWxsYmFjazogKGVycj86IEVycm9yKSA9PiB2b2lkID0gKCkgPT4ge1xyXG4gIH0pOiB2b2lkIHtcclxuICAgIHRoaXMuX3F1ZXJ5ID0gcXVlcnk7XHJcblxyXG4gICAgY2xlYXJUaW1lb3V0KHRoaXMuX3NlYXJjaERlbGF5VGltZW91dCk7XHJcbiAgICB0aGlzLl9zZWFyY2hEZWxheVRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dChcclxuICAgICAgKCkgPT4ge1xyXG4gICAgICAgIHRoaXMudXBkYXRlUXVlcnkocXVlcnksIGNhbGxiYWNrKTtcclxuICAgICAgfSxcclxuICAgICAgdGhpcy5zZWFyY2hEZWxheVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIFVwZGF0ZXMgdGhlIGN1cnJlbnQgc2VhcmNoIHF1ZXJ5LlxyXG4gIHB1YmxpYyB1cGRhdGVRdWVyeShxdWVyeTogc3RyaW5nLCBjYWxsYmFjazogKGVycj86IEVycm9yKSA9PiB2b2lkID0gKCkgPT4ge1xyXG4gIH0pOiB2b2lkIHtcclxuICAgIHRoaXMuX3F1ZXJ5ID0gcXVlcnk7XHJcblxyXG4gICAgaWYgKHRoaXMuX3F1ZXJ5ID09PSAnJyAmJiAhdGhpcy5hbGxvd0VtcHR5UXVlcnkpIHtcclxuICAgICAgLy8gRG9uJ3QgdXBkYXRlIGlmIHRoZSBuZXcgcXVlcnkgaXMgZW1wdHkgKGFuZCB3ZSBkb24ndCBhbGxvdyBlbXB0eSBxdWVyaWVzKS5cclxuICAgICAgLy8gRG9uJ3QgcmVzZXQgc28gdGhhdCB3aGVuIGFuaW1hdGluZyBjbG9zZWQgd2UgZG9uJ3QgZ2V0IGEganVkZGVyLlxyXG4gICAgICByZXR1cm4gY2FsbGJhY2soKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5fcmVzdWx0c0NhY2hlLmhhc093blByb3BlcnR5KHRoaXMuX3F1ZXJ5KSkge1xyXG4gICAgICAvLyBJZiB0aGUgcXVlcnkgaXMgYWxyZWFkeSBjYWNoZWQsIG1ha2UgdXNlIG9mIGl0LlxyXG4gICAgICB0aGlzLl9yZXN1bHRzID0gdGhpcy5fcmVzdWx0c0NhY2hlW3RoaXMuX3F1ZXJ5XTtcclxuXHJcbiAgICAgIHJldHVybiBjYWxsYmFjaygpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLl9vcHRpb25zTG9va3VwKSB7XHJcbiAgICAgIHRoaXMuX2lzU2VhcmNoaW5nID0gdHJ1ZTtcclxuXHJcbiAgICAgIC8vIENhbGwgdGhlIG9wdGlvbnMgbG9va3VwIHdpdGhvdXQgYSB0aGlzIGNvbnRleHQuXHJcbiAgICAgIGNvbnN0IHF1ZXJ5TG9va3VwID0gdGhpcy5fb3B0aW9uc0xvb2t1cC5jYWxsKHVuZGVmaW5lZCwgdGhpcy5fcXVlcnkpIGFzIExvb2t1cEZuUmVzdWx0PFRbXT47XHJcblxyXG4gICAgICBxdWVyeUxvb2t1cFxyXG4gICAgICAgIC50aGVuKHJlc3VsdHMgPT4ge1xyXG4gICAgICAgICAgdGhpcy5faXNTZWFyY2hpbmcgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgICB0aGlzLnVwZGF0ZVJlc3VsdHMocmVzdWx0cyk7XHJcbiAgICAgICAgICByZXR1cm4gY2FsbGJhY2soKTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaChlcnJvciA9PiB7XHJcbiAgICAgICAgICAvLyBVbnNldCAnbG9hZGluZycgc3RhdGUsIGFuZCB0aHJvdyB0aGUgcmV0dXJuZWQgZXJyb3Igd2l0aG91dCB1cGRhdGluZyB0aGUgcmVzdWx0cy5cclxuICAgICAgICAgIHRoaXMuX2lzU2VhcmNoaW5nID0gZmFsc2U7XHJcbiAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyb3IpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGZpbHRlcmVkID0gdGhpcy5vcHRpb25zRmlsdGVyLmNhbGwodW5kZWZpbmVkLCB0aGlzLl9vcHRpb25zLCB0aGlzLl9xdWVyeSk7XHJcbiAgICBpZiAoZmlsdGVyZWQpIHtcclxuICAgICAgdGhpcy51cGRhdGVSZXN1bHRzKGZpbHRlcmVkKTtcclxuICAgIH1cclxuICAgIHJldHVybiBjYWxsYmFjaygpO1xyXG4gIH1cclxuXHJcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnByb21pc2UtZnVuY3Rpb24tYXN5bmNcclxuICBwdWJsaWMgaW5pdGlhbExvb2t1cChpbml0aWFsOiBVKTogTG9va3VwRm5SZXN1bHQ8VD47XHJcblxyXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpwcm9taXNlLWZ1bmN0aW9uLWFzeW5jXHJcbiAgcHVibGljIGluaXRpYWxMb29rdXAoaW5pdGlhbDogVVtdKTogTG9va3VwRm5SZXN1bHQ8VFtdPjtcclxuXHJcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnByb21pc2UtZnVuY3Rpb24tYXN5bmNcclxuICBwdWJsaWMgaW5pdGlhbExvb2t1cChpbml0aWFsOiBVIHwgVVtdKTogTG9va3VwRm5SZXN1bHQ8VD4gfCBMb29rdXBGblJlc3VsdDxUW10+IHtcclxuICAgIGlmIChpbml0aWFsIGluc3RhbmNlb2YgQXJyYXkpIHtcclxuICAgICAgcmV0dXJuICh0aGlzLl9vcHRpb25zTG9va3VwIGFzIHVua25vd24gYXMgTG9va3VwRm48VCwgVVtdPikodW5kZWZpbmVkLCBpbml0aWFsKSBhcyBMb29rdXBGblJlc3VsdDxUW10+O1xyXG4gICAgfVxyXG4gICAgcmV0dXJuICh0aGlzLl9vcHRpb25zTG9va3VwIGFzIHVua25vd24gYXMgTG9va3VwRm48VCwgVT4pKHVuZGVmaW5lZCwgaW5pdGlhbCkgYXMgTG9va3VwRm5SZXN1bHQ8VD47XHJcbiAgfVxyXG5cclxuICAvLyBHZW5lcmF0ZXMgSFRNTCBmb3IgaGlnaGxpZ2h0ZWQgbWF0Y2ggdGV4dC5cclxuICBwdWJsaWMgaGlnaGxpZ2h0TWF0Y2hlcyh0ZXh0OiBzdHJpbmcsIHF1ZXJ5OiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgcmVnZXggPSB0aGlzLnRvUmVnZXgocXVlcnkpO1xyXG4gICAgaWYgKHJlZ2V4IGluc3RhbmNlb2YgUmVnRXhwKSB7XHJcbiAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UocmVnZXgsIG1hdGNoID0+IGA8Yj4ke21hdGNofTwvYj5gKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0ZXh0O1xyXG4gIH1cclxuXHJcbiAgLy8gVXBkYXRlcyAmIGNhY2hlcyB0aGUgbmV3IHNldCBvZiByZXN1bHRzLlxyXG4gIHByaXZhdGUgdXBkYXRlUmVzdWx0cyhyZXN1bHRzOiBUW10pOiB2b2lkIHtcclxuICAgIHRoaXMuX3Jlc3VsdHNDYWNoZVt0aGlzLl9xdWVyeV0gPSByZXN1bHRzO1xyXG4gICAgdGhpcy5fcmVzdWx0cyA9IHJlc3VsdHM7XHJcbiAgfVxyXG5cclxuICAvLyBDb252ZXJ0cyBhIHF1ZXJ5IHN0cmluZyB0byByZWdleCB3aXRob3V0IHRocm93aW5nIGFuIGVycm9yLlxyXG4gIHByaXZhdGUgdG9SZWdleChxdWVyeTogc3RyaW5nKTogUmVnRXhwIHwgc3RyaW5nIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIHJldHVybiBuZXcgUmVnRXhwKHF1ZXJ5LCAnaScpO1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICByZXR1cm4gcXVlcnk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBSZXNldHMgdGhlIHNlYXJjaCBiYWNrIHRvIGEgcHJpc3RpbmUgc3RhdGUuXHJcbiAgcHJpdmF0ZSByZXNldCgpOiB2b2lkIHtcclxuICAgIHRoaXMuX3Jlc3VsdHMgPSBbXTtcclxuICAgIHRoaXMuX3Jlc3VsdHNDYWNoZSA9IHt9O1xyXG4gICAgdGhpcy5faXNTZWFyY2hpbmcgPSBmYWxzZTtcclxuICAgIHRoaXMudXBkYXRlUXVlcnkoJycpO1xyXG4gIH1cclxufVxyXG4iXX0=