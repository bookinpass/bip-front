/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Util } from '../../../misc/util/internal';
/**
 * @record
 * @template T
 */
function ICachedArray() { }
/**
 * @template T, U
 */
export class SearchService {
    /**
     * @param {?=} allowEmptyQuery
     */
    constructor(allowEmptyQuery = false) {
        this._options = [];
        this.optionsFilter = (/**
         * @param {?} os
         * @param {?} q
         * @return {?}
         */
        (os, q) => {
            // Convert the query string to a RegExp.
            /** @type {?} */
            const regex = this.toRegex(this._query);
            if (regex instanceof RegExp) {
                // Only update the results if the query was valid regex.
                // This avoids the results suddenly becoming empty if an invalid regex string is inputted.
                return os
                    // Filter on the options with a string match on the field we are testing.
                    .filter((/**
                 * @param {?} o
                 * @return {?}
                 */
                o => Util.Object.readValue(o, this._optionsField)
                    .toString()
                    .match(regex)));
            }
            // Don't update since it wasn't a valid regex.
            return false;
        });
        // Set default values and reset.
        this.allowEmptyQuery = allowEmptyQuery;
        this.searchDelay = 0;
        this.reset();
    }
    /**
     * @return {?}
     */
    get hasItemLookup() {
        return !!this.optionsLookup && this.optionsLookup.length === 2;
    }
    /**
     * @return {?}
     */
    get options() {
        return this._options;
    }
    /**
     * @param {?} options
     * @return {?}
     */
    set options(options) {
        this._options = options || [];
        // We cannot use both local & remote options simultaneously.
        this._optionsLookup = undefined;
        // Reset entire service with new options.
        this.reset();
    }
    /**
     * @return {?}
     */
    get optionsLookup() {
        return this._optionsLookup;
    }
    /**
     * @param {?} lookupFn
     * @return {?}
     */
    set optionsLookup(lookupFn) {
        this._optionsLookup = lookupFn;
        // As before, cannot use local & remote options simultaneously.
        this._options = [];
        this.reset();
    }
    /**
     * @return {?}
     */
    get optionsField() {
        return this._optionsField;
    }
    /**
     * @param {?} field
     * @return {?}
     */
    set optionsField(field) {
        this._optionsField = field;
        // We need to reset otherwise we would now be showing invalid search results.
        this.reset();
    }
    /**
     * @return {?}
     */
    get results() {
        return this._results;
    }
    /**
     * @return {?}
     */
    get query() {
        return this._query;
    }
    /**
     * @return {?}
     */
    get isSearching() {
        return this._isSearching;
    }
    // Updates the query after the specified search delay.
    /**
     * @param {?} query
     * @param {?=} callback
     * @return {?}
     */
    updateQueryDelayed(query, callback = (/**
     * @return {?}
     */
    () => {
    })) {
        this._query = query;
        clearTimeout(this._searchDelayTimeout);
        this._searchDelayTimeout = window.setTimeout((/**
         * @return {?}
         */
        () => {
            this.updateQuery(query, callback);
        }), this.searchDelay);
    }
    // Updates the current search query.
    /**
     * @param {?} query
     * @param {?=} callback
     * @return {?}
     */
    updateQuery(query, callback = (/**
     * @return {?}
     */
    () => {
    })) {
        this._query = query;
        if (this._query === '' && !this.allowEmptyQuery) {
            // Don't update if the new query is empty (and we don't allow empty queries).
            // Don't reset so that when animating closed we don't get a judder.
            return callback();
        }
        if (this._resultsCache.hasOwnProperty(this._query)) {
            // If the query is already cached, make use of it.
            this._results = this._resultsCache[this._query];
            return callback();
        }
        if (this._optionsLookup) {
            this._isSearching = true;
            // Call the options lookup without a this context.
            /** @type {?} */
            const queryLookup = (/** @type {?} */ (this._optionsLookup.call(undefined, this._query)));
            queryLookup
                .then((/**
             * @param {?} results
             * @return {?}
             */
            results => {
                this._isSearching = false;
                this.updateResults(results);
                return callback();
            }))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            error => {
                // Unset 'loading' state, and throw the returned error without updating the results.
                this._isSearching = false;
                return callback(error);
            }));
            return;
        }
        /** @type {?} */
        const filtered = this.optionsFilter.call(undefined, this._options, this._query);
        if (filtered) {
            this.updateResults(filtered);
        }
        return callback();
    }
    // tslint:disable-next-line:promise-function-async
    /**
     * @param {?} initial
     * @return {?}
     */
    initialLookup(initial) {
        if (initial instanceof Array) {
            return (/** @type {?} */ (((/** @type {?} */ ((/** @type {?} */ (this._optionsLookup)))))(undefined, initial)));
        }
        return (/** @type {?} */ (((/** @type {?} */ ((/** @type {?} */ (this._optionsLookup)))))(undefined, initial)));
    }
    // Generates HTML for highlighted match text.
    /**
     * @param {?} text
     * @param {?} query
     * @return {?}
     */
    highlightMatches(text, query) {
        /** @type {?} */
        const regex = this.toRegex(query);
        if (regex instanceof RegExp) {
            return text.replace(regex, (/**
             * @param {?} match
             * @return {?}
             */
            match => `<b>${match}</b>`));
        }
        return text;
    }
    // Updates & caches the new set of results.
    /**
     * @private
     * @param {?} results
     * @return {?}
     */
    updateResults(results) {
        this._resultsCache[this._query] = results;
        this._results = results;
    }
    // Converts a query string to regex without throwing an error.
    /**
     * @private
     * @param {?} query
     * @return {?}
     */
    toRegex(query) {
        try {
            return new RegExp(query, 'i');
        }
        catch (e) {
            return query;
        }
    }
    // Resets the search back to a pristine state.
    /**
     * @private
     * @return {?}
     */
    reset() {
        this._results = [];
        this._resultsCache = {};
        this._isSearching = false;
        this.updateQuery('');
    }
}
if (false) {
    /** @type {?} */
    SearchService.prototype.optionsFilter;
    /** @type {?} */
    SearchService.prototype.allowEmptyQuery;
    /** @type {?} */
    SearchService.prototype.searchDelay;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._resultsCache;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._searchDelayTimeout;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._options;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._optionsLookup;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._optionsField;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._results;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._query;
    /**
     * @type {?}
     * @private
     */
    SearchService.prototype._isSearching;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtZm9tYW50aWMtdWkvIiwic291cmNlcyI6WyJtb2R1bGVzL3NlYXJjaC9zZXJ2aWNlcy9zZWFyY2guc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLDZCQUE2QixDQUFDOzs7OztBQUdqRCwyQkFFQzs7OztBQUVELE1BQU0sT0FBTyxhQUFhOzs7O0lBYXhCLFlBQVksa0JBQTJCLEtBQUs7UUFDMUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLGFBQWE7Ozs7O1FBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUU7OztrQkFFdkIsS0FBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztZQUV2QyxJQUFJLEtBQUssWUFBWSxNQUFNLEVBQUU7Z0JBQzNCLHdEQUF3RDtnQkFDeEQsMEZBQTBGO2dCQUMxRixPQUFPLEVBQUU7b0JBQ1QseUVBQXlFO3FCQUN0RSxNQUFNOzs7O2dCQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQVksQ0FBQyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUM7cUJBQ2pFLFFBQVEsRUFBRTtxQkFDVixLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUMsQ0FBQzthQUNwQjtZQUVELDhDQUE4QztZQUM5QyxPQUFPLEtBQUssQ0FBQztRQUNmLENBQUMsQ0FBQSxDQUFDO1FBRUYsZ0NBQWdDO1FBQ2hDLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNmLENBQUM7Ozs7SUFFRCxJQUFXLGFBQWE7UUFDdEIsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLGFB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QUFLLENBQUMsRUFBRSxDQUFDLE1BQU0sS0FBSyxNQUFNLEVBQUMsQ0FBQztTQUN4RDtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQzs7Ozs7OztJQUdPLGFBQWEsQ0FBQyxPQUFZO1FBQ2hDLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLE9BQU8sQ0FBQztRQUMxQyxJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztJQUMxQixDQUFDOzs7Ozs7O0lBR08sT0FBTyxDQUFDLEtBQWE7UUFDM0IsSUFBSTtZQUNGLE9BQU8sSUFBSSxNQUFNLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQy9CO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixPQUFPLEtBQUssQ0FBQztTQUNkO0lBQ0gsQ0FBQzs7Ozs7O0lBR08sS0FBSztRQUNYLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDO1FBQzFCLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDdkIsQ0FBQztDQUNGOzs7SUFoTkMsc0NBQWtDOztJQUVsQyx3Q0FBZ0M7O0lBRWhDLG9DQUEyQjs7Ozs7SUFFM0Isc0NBQXVDOzs7OztJQUV2Qyw0Q0FBb0M7Ozs7O0lBaUNwQyxpQ0FBc0I7Ozs7O0lBZXRCLHVDQUF3Qzs7Ozs7SUFjeEMsc0NBQStCOzs7OztJQWEvQixpQ0FBc0I7Ozs7O0lBTXRCLCtCQUF1Qjs7Ozs7SUFPdkIscUNBQThCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtVdGlsfSBmcm9tICcuLi8uLi8uLi9taXNjL3V0aWwvaW50ZXJuYWwnO1xyXG5pbXBvcnQge0ZpbHRlckZuLCBMb29rdXBGbiwgTG9va3VwRm5SZXN1bHR9IGZyb20gJy4uL2hlbHBlcnMvbG9va3VwLWZuJztcclxuXHJcbmludGVyZmFjZSBJQ2FjaGVkQXJyYXk8VD4ge1xyXG4gIFtxdWVyeTogc3RyaW5nXTogVFtdO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgU2VhcmNoU2VydmljZTxULCBVPiB7XHJcblxyXG4gIC8vIEZpbHRlcnMgYSBsaXN0IG9mIG9wdGlvbnMuXHJcbiAgcHVibGljIG9wdGlvbnNGaWx0ZXI6IEZpbHRlckZuPFQ+O1xyXG4gIC8vIEFsbG93cyB0aGUgZW1wdHkgcXVlcnkgdG8gcHJvZHVjZSByZXN1bHRzLlxyXG4gIHB1YmxpYyBhbGxvd0VtcHR5UXVlcnk6IGJvb2xlYW47XHJcbiAgLy8gSG93IGxvbmcgdG8gZGVsYXkgdGhlIHNlYXJjaCBmb3Igd2hlbiB1c2luZyB1cGRhdGVRdWVyeURlbGF5ZWQuIFN0b3JlZCBpbiBtcy5cclxuICBwdWJsaWMgc2VhcmNoRGVsYXk6IG51bWJlcjtcclxuICAvLyBDYWNoZSBvZiByZXN1bHRzLCBpbmRleGVkIGJ5IHF1ZXJ5LlxyXG4gIHByaXZhdGUgX3Jlc3VsdHNDYWNoZTogSUNhY2hlZEFycmF5PFQ+O1xyXG4gIC8vIFN0b3JlcyB0aGUgc2VhcmNoIHRpbWVvdXQgaGFuZGxlIHNvIHdlIGNhbiBjYW5jZWwgaXQuXHJcbiAgcHJpdmF0ZSBfc2VhcmNoRGVsYXlUaW1lb3V0OiBudW1iZXI7XHJcblxyXG4gIGNvbnN0cnVjdG9yKGFsbG93RW1wdHlRdWVyeTogYm9vbGVhbiA9IGZhbHNlKSB7XHJcbiAgICB0aGlzLl9vcHRpb25zID0gW107XHJcbiAgICB0aGlzLm9wdGlvbnNGaWx0ZXIgPSAob3MsIHEpID0+IHtcclxuICAgICAgLy8gQ29udmVydCB0aGUgcXVlcnkgc3RyaW5nIHRvIGEgUmVnRXhwLlxyXG4gICAgICBjb25zdCByZWdleCA9IHRoaXMudG9SZWdleCh0aGlzLl9xdWVyeSk7XHJcblxyXG4gICAgICBpZiAocmVnZXggaW5zdGFuY2VvZiBSZWdFeHApIHtcclxuICAgICAgICAvLyBPbmx5IHVwZGF0ZSB0aGUgcmVzdWx0cyBpZiB0aGUgcXVlcnkgd2FzIHZhbGlkIHJlZ2V4LlxyXG4gICAgICAgIC8vIFRoaXMgYXZvaWRzIHRoZSByZXN1bHRzIHN1ZGRlbmx5IGJlY29taW5nIGVtcHR5IGlmIGFuIGludmFsaWQgcmVnZXggc3RyaW5nIGlzIGlucHV0dGVkLlxyXG4gICAgICAgIHJldHVybiBvc1xyXG4gICAgICAgIC8vIEZpbHRlciBvbiB0aGUgb3B0aW9ucyB3aXRoIGEgc3RyaW5nIG1hdGNoIG9uIHRoZSBmaWVsZCB3ZSBhcmUgdGVzdGluZy5cclxuICAgICAgICAgIC5maWx0ZXIobyA9PiBVdGlsLk9iamVjdC5yZWFkVmFsdWU8VCwgc3RyaW5nPihvLCB0aGlzLl9vcHRpb25zRmllbGQpXHJcbiAgICAgICAgICAgIC50b1N0cmluZygpXHJcbiAgICAgICAgICAgIC5tYXRjaChyZWdleCkpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBEb24ndCB1cGRhdGUgc2luY2UgaXQgd2Fzbid0IGEgdmFsaWQgcmVnZXguXHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gU2V0IGRlZmF1bHQgdmFsdWVzIGFuZCByZXNldC5cclxuICAgIHRoaXMuYWxsb3dFbXB0eVF1ZXJ5ID0gYWxsb3dFbXB0eVF1ZXJ5O1xyXG4gICAgdGhpcy5zZWFyY2hEZWxheSA9IDA7XHJcbiAgICB0aGlzLnJlc2V0KCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0IGhhc0l0ZW1Mb29rdXAoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gISF0aGlzLm9wdGlvbnNMb29rdXAgJiYgdGhpcy5vcHRpb25zTG9va3VwLmxlbmd0aCA9PT0gMjtcclxuICB9XHJcblxyXG4gIC8vIFN0b3JlcyB0aGUgYXZhaWxhYmxlIG9wdGlvbnMuXHJcbiAgcHJpdmF0ZSBfb3B0aW9uczogVFtdO1xyXG5cclxuICBwdWJsaWMgZ2V0IG9wdGlvbnMoKTogVFtdIHtcclxuICAgIHJldHVybiB0aGlzLl9vcHRpb25zO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNldCBvcHRpb25zKG9wdGlvbnM6IFRbXSkge1xyXG4gICAgdGhpcy5fb3B0aW9ucyA9IG9wdGlvbnMgfHwgW107XHJcbiAgICAvLyBXZSBjYW5ub3QgdXNlIGJvdGggbG9jYWwgJiByZW1vdGUgb3B0aW9ucyBzaW11bHRhbmVvdXNseS5cclxuICAgIHRoaXMuX29wdGlvbnNMb29rdXAgPSB1bmRlZmluZWQ7XHJcbiAgICAvLyBSZXNldCBlbnRpcmUgc2VydmljZSB3aXRoIG5ldyBvcHRpb25zLlxyXG4gICAgdGhpcy5yZXNldCgpO1xyXG4gIH1cclxuXHJcbiAgLy8gQ29udmVydHMgYSBxdWVyeSBzdHJpbmcgaW50byBhbiBhcnJheSBvZiBvcHRpb25zLiBNdXN0IGJlIGEgZnVuY3Rpb24gcmV0dXJuaW5nIGEgcHJvbWlzZS5cclxuICBwcml2YXRlIF9vcHRpb25zTG9va3VwPzogTG9va3VwRm48VCwgVT47XHJcblxyXG4gIHB1YmxpYyBnZXQgb3B0aW9uc0xvb2t1cCgpOiBMb29rdXBGbjxULCBVPiB8IHVuZGVmaW5lZCB7XHJcbiAgICByZXR1cm4gdGhpcy5fb3B0aW9uc0xvb2t1cDtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzZXQgb3B0aW9uc0xvb2t1cChsb29rdXBGbjogTG9va3VwRm48VCwgVT4gfCB1bmRlZmluZWQpIHtcclxuICAgIHRoaXMuX29wdGlvbnNMb29rdXAgPSBsb29rdXBGbjtcclxuICAgIC8vIEFzIGJlZm9yZSwgY2Fubm90IHVzZSBsb2NhbCAmIHJlbW90ZSBvcHRpb25zIHNpbXVsdGFuZW91c2x5LlxyXG4gICAgdGhpcy5fb3B0aW9ucyA9IFtdO1xyXG4gICAgdGhpcy5yZXNldCgpO1xyXG4gIH1cclxuXHJcbiAgLy8gRmllbGQgdGhhdCBvcHRpb25zIGFyZSBzZWFyY2hlZCAmIGRpc3BsYXllZCBvbi5cclxuICBwcml2YXRlIF9vcHRpb25zRmllbGQ/OiBzdHJpbmc7XHJcblxyXG4gIHB1YmxpYyBnZXQgb3B0aW9uc0ZpZWxkKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XHJcbiAgICByZXR1cm4gdGhpcy5fb3B0aW9uc0ZpZWxkO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNldCBvcHRpb25zRmllbGQoZmllbGQ6IHN0cmluZyB8IHVuZGVmaW5lZCkge1xyXG4gICAgdGhpcy5fb3B0aW9uc0ZpZWxkID0gZmllbGQ7XHJcbiAgICAvLyBXZSBuZWVkIHRvIHJlc2V0IG90aGVyd2lzZSB3ZSB3b3VsZCBub3cgYmUgc2hvd2luZyBpbnZhbGlkIHNlYXJjaCByZXN1bHRzLlxyXG4gICAgdGhpcy5yZXNldCgpO1xyXG4gIH1cclxuXHJcbiAgLy8gU3RvcmVzIHRoZSByZXN1bHRzIG9mIHRoZSBxdWVyeS5cclxuICBwcml2YXRlIF9yZXN1bHRzOiBUW107XHJcblxyXG4gIHB1YmxpYyBnZXQgcmVzdWx0cygpOiBUW10ge1xyXG4gICAgcmV0dXJuIHRoaXMuX3Jlc3VsdHM7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9xdWVyeTogc3RyaW5nO1xyXG5cclxuICBwdWJsaWMgZ2V0IHF1ZXJ5KCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5fcXVlcnk7XHJcbiAgfVxyXG5cclxuICAvLyBQcm92aWRlcyAnbG9hZGluZycgZnVuY3Rpb25hbGl0eS5cclxuICBwcml2YXRlIF9pc1NlYXJjaGluZzogYm9vbGVhbjtcclxuXHJcbiAgcHVibGljIGdldCBpc1NlYXJjaGluZygpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzLl9pc1NlYXJjaGluZztcclxuICB9XHJcblxyXG4gIC8vIFVwZGF0ZXMgdGhlIHF1ZXJ5IGFmdGVyIHRoZSBzcGVjaWZpZWQgc2VhcmNoIGRlbGF5LlxyXG4gIHB1YmxpYyB1cGRhdGVRdWVyeURlbGF5ZWQocXVlcnk6IHN0cmluZywgY2FsbGJhY2s6IChlcnI/OiBFcnJvcikgPT4gdm9pZCA9ICgpID0+IHtcclxuICB9KTogdm9pZCB7XHJcbiAgICB0aGlzLl9xdWVyeSA9IHF1ZXJ5O1xyXG5cclxuICAgIGNsZWFyVGltZW91dCh0aGlzLl9zZWFyY2hEZWxheVRpbWVvdXQpO1xyXG4gICAgdGhpcy5fc2VhcmNoRGVsYXlUaW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQoXHJcbiAgICAgICgpID0+IHtcclxuICAgICAgICB0aGlzLnVwZGF0ZVF1ZXJ5KHF1ZXJ5LCBjYWxsYmFjayk7XHJcbiAgICAgIH0sXHJcbiAgICAgIHRoaXMuc2VhcmNoRGVsYXlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvLyBVcGRhdGVzIHRoZSBjdXJyZW50IHNlYXJjaCBxdWVyeS5cclxuICBwdWJsaWMgdXBkYXRlUXVlcnkocXVlcnk6IHN0cmluZywgY2FsbGJhY2s6IChlcnI/OiBFcnJvcikgPT4gdm9pZCA9ICgpID0+IHtcclxuICB9KTogdm9pZCB7XHJcbiAgICB0aGlzLl9xdWVyeSA9IHF1ZXJ5O1xyXG5cclxuICAgIGlmICh0aGlzLl9xdWVyeSA9PT0gJycgJiYgIXRoaXMuYWxsb3dFbXB0eVF1ZXJ5KSB7XHJcbiAgICAgIC8vIERvbid0IHVwZGF0ZSBpZiB0aGUgbmV3IHF1ZXJ5IGlzIGVtcHR5IChhbmQgd2UgZG9uJ3QgYWxsb3cgZW1wdHkgcXVlcmllcykuXHJcbiAgICAgIC8vIERvbid0IHJlc2V0IHNvIHRoYXQgd2hlbiBhbmltYXRpbmcgY2xvc2VkIHdlIGRvbid0IGdldCBhIGp1ZGRlci5cclxuICAgICAgcmV0dXJuIGNhbGxiYWNrKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuX3Jlc3VsdHNDYWNoZS5oYXNPd25Qcm9wZXJ0eSh0aGlzLl9xdWVyeSkpIHtcclxuICAgICAgLy8gSWYgdGhlIHF1ZXJ5IGlzIGFscmVhZHkgY2FjaGVkLCBtYWtlIHVzZSBvZiBpdC5cclxuICAgICAgdGhpcy5fcmVzdWx0cyA9IHRoaXMuX3Jlc3VsdHNDYWNoZVt0aGlzLl9xdWVyeV07XHJcblxyXG4gICAgICByZXR1cm4gY2FsbGJhY2soKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5fb3B0aW9uc0xvb2t1cCkge1xyXG4gICAgICB0aGlzLl9pc1NlYXJjaGluZyA9IHRydWU7XHJcblxyXG4gICAgICAvLyBDYWxsIHRoZSBvcHRpb25zIGxvb2t1cCB3aXRob3V0IGEgdGhpcyBjb250ZXh0LlxyXG4gICAgICBjb25zdCBxdWVyeUxvb2t1cCA9IHRoaXMuX29wdGlvbnNMb29rdXAuY2FsbCh1bmRlZmluZWQsIHRoaXMuX3F1ZXJ5KSBhcyBMb29rdXBGblJlc3VsdDxUW10+O1xyXG5cclxuICAgICAgcXVlcnlMb29rdXBcclxuICAgICAgICAudGhlbihyZXN1bHRzID0+IHtcclxuICAgICAgICAgIHRoaXMuX2lzU2VhcmNoaW5nID0gZmFsc2U7XHJcblxyXG4gICAgICAgICAgdGhpcy51cGRhdGVSZXN1bHRzKHJlc3VsdHMpO1xyXG4gICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKCk7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goZXJyb3IgPT4ge1xyXG4gICAgICAgICAgLy8gVW5zZXQgJ2xvYWRpbmcnIHN0YXRlLCBhbmQgdGhyb3cgdGhlIHJldHVybmVkIGVycm9yIHdpdGhvdXQgdXBkYXRpbmcgdGhlIHJlc3VsdHMuXHJcbiAgICAgICAgICB0aGlzLl9pc1NlYXJjaGluZyA9IGZhbHNlO1xyXG4gICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycm9yKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBmaWx0ZXJlZCA9IHRoaXMub3B0aW9uc0ZpbHRlci5jYWxsKHVuZGVmaW5lZCwgdGhpcy5fb3B0aW9ucywgdGhpcy5fcXVlcnkpO1xyXG4gICAgaWYgKGZpbHRlcmVkKSB7XHJcbiAgICAgIHRoaXMudXBkYXRlUmVzdWx0cyhmaWx0ZXJlZCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gY2FsbGJhY2soKTtcclxuICB9XHJcblxyXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpwcm9taXNlLWZ1bmN0aW9uLWFzeW5jXHJcbiAgcHVibGljIGluaXRpYWxMb29rdXAoaW5pdGlhbDogVSk6IExvb2t1cEZuUmVzdWx0PFQ+O1xyXG5cclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6cHJvbWlzZS1mdW5jdGlvbi1hc3luY1xyXG4gIHB1YmxpYyBpbml0aWFsTG9va3VwKGluaXRpYWw6IFVbXSk6IExvb2t1cEZuUmVzdWx0PFRbXT47XHJcblxyXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpwcm9taXNlLWZ1bmN0aW9uLWFzeW5jXHJcbiAgcHVibGljIGluaXRpYWxMb29rdXAoaW5pdGlhbDogVSB8IFVbXSk6IExvb2t1cEZuUmVzdWx0PFQ+IHwgTG9va3VwRm5SZXN1bHQ8VFtdPiB7XHJcbiAgICBpZiAoaW5pdGlhbCBpbnN0YW5jZW9mIEFycmF5KSB7XHJcbiAgICAgIHJldHVybiAodGhpcy5fb3B0aW9uc0xvb2t1cCBhcyB1bmtub3duIGFzIExvb2t1cEZuPFQsIFVbXT4pKHVuZGVmaW5lZCwgaW5pdGlhbCkgYXMgTG9va3VwRm5SZXN1bHQ8VFtdPjtcclxuICAgIH1cclxuICAgIHJldHVybiAodGhpcy5fb3B0aW9uc0xvb2t1cCBhcyB1bmtub3duIGFzIExvb2t1cEZuPFQsIFU+KSh1bmRlZmluZWQsIGluaXRpYWwpIGFzIExvb2t1cEZuUmVzdWx0PFQ+O1xyXG4gIH1cclxuXHJcbiAgLy8gR2VuZXJhdGVzIEhUTUwgZm9yIGhpZ2hsaWdodGVkIG1hdGNoIHRleHQuXHJcbiAgcHVibGljIGhpZ2hsaWdodE1hdGNoZXModGV4dDogc3RyaW5nLCBxdWVyeTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IHJlZ2V4ID0gdGhpcy50b1JlZ2V4KHF1ZXJ5KTtcclxuICAgIGlmIChyZWdleCBpbnN0YW5jZW9mIFJlZ0V4cCkge1xyXG4gICAgICByZXR1cm4gdGV4dC5yZXBsYWNlKHJlZ2V4LCBtYXRjaCA9PiBgPGI+JHttYXRjaH08L2I+YCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGV4dDtcclxuICB9XHJcblxyXG4gIC8vIFVwZGF0ZXMgJiBjYWNoZXMgdGhlIG5ldyBzZXQgb2YgcmVzdWx0cy5cclxuICBwcml2YXRlIHVwZGF0ZVJlc3VsdHMocmVzdWx0czogVFtdKTogdm9pZCB7XHJcbiAgICB0aGlzLl9yZXN1bHRzQ2FjaGVbdGhpcy5fcXVlcnldID0gcmVzdWx0cztcclxuICAgIHRoaXMuX3Jlc3VsdHMgPSByZXN1bHRzO1xyXG4gIH1cclxuXHJcbiAgLy8gQ29udmVydHMgYSBxdWVyeSBzdHJpbmcgdG8gcmVnZXggd2l0aG91dCB0aHJvd2luZyBhbiBlcnJvci5cclxuICBwcml2YXRlIHRvUmVnZXgocXVlcnk6IHN0cmluZyk6IFJlZ0V4cCB8IHN0cmluZyB7XHJcbiAgICB0cnkge1xyXG4gICAgICByZXR1cm4gbmV3IFJlZ0V4cChxdWVyeSwgJ2knKTtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgcmV0dXJuIHF1ZXJ5O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gUmVzZXRzIHRoZSBzZWFyY2ggYmFjayB0byBhIHByaXN0aW5lIHN0YXRlLlxyXG4gIHByaXZhdGUgcmVzZXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9yZXN1bHRzID0gW107XHJcbiAgICB0aGlzLl9yZXN1bHRzQ2FjaGUgPSB7fTtcclxuICAgIHRoaXMuX2lzU2VhcmNoaW5nID0gZmFsc2U7XHJcbiAgICB0aGlzLnVwZGF0ZVF1ZXJ5KCcnKTtcclxuICB9XHJcbn1cclxuIl19