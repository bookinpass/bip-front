/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Input, QueryList, ViewChildren } from '@angular/core';
import { KeyCode } from '../../../misc/util/internal';
import { FuiCalendarItem } from '../directives/calendar-item';
import { CalendarService } from '../services/calendar.service';
/** @enum {number} */
const CalendarViewType = {
    Year: 0,
    Month: 1,
    Date: 2,
    Hour: 3,
    Minute: 4,
};
export { CalendarViewType };
CalendarViewType[CalendarViewType.Year] = 'Year';
CalendarViewType[CalendarViewType.Month] = 'Month';
CalendarViewType[CalendarViewType.Date] = 'Date';
CalendarViewType[CalendarViewType.Hour] = 'Hour';
CalendarViewType[CalendarViewType.Minute] = 'Minute';
/**
 * @abstract
 */
export class CalendarView {
    /**
     * @param {?} renderer
     * @param {?} viewType
     * @param {?} ranges
     */
    constructor(renderer, viewType, ranges) {
        this._type = viewType;
        this.ranges = ranges;
        this._documentKeyDownListener = renderer.listen('document', 'keydown', (/**
         * @param {?} e
         * @return {?}
         */
        (e) => this.onDocumentKeyDown(e)));
    }
    /**
     * @return {?}
     */
    get currentDate() {
        return this.service.currentDate;
    }
    /**
     * @return {?}
     */
    get selectedDate() {
        return this.service.selectedDate;
    }
    /**
     * @return {?}
     */
    get service() {
        return this._service;
    }
    /**
     * @param {?} service
     * @return {?}
     */
    set service(service) {
        this._service = service;
        this.ranges.loadService(service);
        this.service.onManualUpdate = (/**
         * @return {?}
         */
        () => {
            this.ranges.refresh();
            delete this._highlightedItem;
            this.autoHighlight();
        });
    }
    // Template Methods
    /**
     * @param {?} item
     * @return {?}
     */
    setDate(item) {
        this.service.changeDate(item.date, this._type);
    }
    /**
     * @return {?}
     */
    zoomOut() {
        this.service.zoomOut(this._type);
    }
    // Keyboard Control
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this._renderedItems.changes.subscribe((/**
         * @return {?}
         */
        () => this.onRenderedItemsChanged()));
        this.onRenderedItemsChanged();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this._documentKeyDownListener();
    }
    /**
     * @private
     * @return {?}
     */
    onRenderedItemsChanged() {
        this._renderedItems.forEach((/**
         * @param {?} i
         * @return {?}
         */
        i => i.onFocussed.subscribe((/**
         * @param {?} hasFocus
         * @return {?}
         */
        (hasFocus) => {
            if (hasFocus) {
                this.highlightItem(i.item);
            }
        }))));
        this.autoHighlight();
        this.highlightItem(this._highlightedItem);
    }
    /**
     * @private
     * @return {?}
     */
    autoHighlight() {
        /** @type {?} */
        let date = this.selectedDate && this.ranges.current.containsDate(this.selectedDate) ? this.selectedDate : this.currentDate;
        if (this._highlightedItem && this.ranges.current.containsDate(this._highlightedItem.date)) {
            date = this._highlightedItem.date;
        }
        /** @type {?} */
        const initiallyHighlighted = this.ranges.current.items.find((/**
         * @param {?} i
         * @return {?}
         */
        i => this.ranges.dateComparer.equal(i.date, date)));
        if (initiallyHighlighted && !initiallyHighlighted.isDisabled) {
            this._highlightedItem = initiallyHighlighted;
        }
    }
    /**
     * @private
     * @param {?} item
     * @return {?}
     */
    highlightItem(item) {
        if (item) {
            this._renderedItems.forEach((/**
             * @param {?} i
             * @return {?}
             */
            i => i.hasFocus = false));
            /** @type {?} */
            const rendered = this._renderedItems.find((/**
             * @param {?} ri
             * @return {?}
             */
            ri => ri.item === item));
            if (rendered && !rendered.hasFocus) {
                rendered.hasFocus = true;
                rendered.changeDetector.detectChanges();
            }
            this._highlightedItem = item;
        }
    }
    /**
     * @private
     * @param {?} e
     * @return {?}
     */
    onDocumentKeyDown(e) {
        if (this._highlightedItem && e.keyCode === KeyCode.Enter) {
            this.setDate(this._highlightedItem);
            return;
        }
        if (!this._highlightedItem) {
            this.autoHighlight();
        }
        /** @type {?} */
        const index = this.ranges.current.findIndex(this._highlightedItem);
        /** @type {?} */
        let isMovingForward = true;
        /** @type {?} */
        let delta = 0;
        switch (e.keyCode) {
            case KeyCode.Right:
                delta += 1;
                break;
            case KeyCode.Left:
                delta -= 1;
                isMovingForward = false;
                break;
            case KeyCode.Down:
                delta += this.ranges.columns;
                break;
            case KeyCode.Up:
                delta -= this.ranges.columns;
                isMovingForward = false;
                break;
            default:
                return;
        }
        // Stop these keypresses being captured elsewhere.
        e.preventDefault();
        /** @type {?} */
        let nextItem = this.ranges.current.items[index + delta];
        if (nextItem && nextItem.isDisabled) {
            return;
        }
        if (nextItem && !nextItem.isOutsideRange) {
            return this.highlightItem(nextItem);
        }
        if (nextItem && nextItem.isOutsideRange) {
            if (index + delta >= this.ranges.current.inRange.length) {
                isMovingForward = true;
            }
        }
        if (!nextItem) {
            /** @type {?} */
            let adjustedIndex = this.ranges.current.findIndex(this._highlightedItem);
            /** @type {?} */
            const nextItems = this.ranges.calc(isMovingForward).inRange;
            if (isMovingForward) {
                adjustedIndex -= this.ranges.current.inRange.length;
            }
            else {
                adjustedIndex += nextItems.length;
            }
            nextItem = nextItems[adjustedIndex + delta];
            if (nextItem.isDisabled) {
                return;
            }
        }
        this.ranges.move(isMovingForward);
        this._highlightedItem = this.ranges.current.find(nextItem);
    }
}
CalendarView.propDecorators = {
    _renderedItems: [{ type: ViewChildren, args: [FuiCalendarItem,] }],
    service: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    CalendarView.prototype.ranges;
    /**
     * @type {?}
     * @private
     */
    CalendarView.prototype._type;
    /**
     * @type {?}
     * @private
     */
    CalendarView.prototype._renderedItems;
    /**
     * @type {?}
     * @private
     */
    CalendarView.prototype._highlightedItem;
    /**
     * @type {?}
     * @private
     */
    CalendarView.prototype._documentKeyDownListener;
    /**
     * @type {?}
     * @private
     */
    CalendarView.prototype._service;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsZW5kYXItdmlldy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1mb21hbnRpYy11aS8iLCJzb3VyY2VzIjpbIm1vZHVsZXMvZGF0ZXBpY2tlci92aWV3cy9jYWxlbmRhci12aWV3LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQWdCLEtBQUssRUFBYSxTQUFTLEVBQWEsWUFBWSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ2xHLE9BQU8sRUFBQyxPQUFPLEVBQUMsTUFBTSw2QkFBNkIsQ0FBQztBQUNwRCxPQUFPLEVBQWUsZUFBZSxFQUFDLE1BQU0sNkJBQTZCLENBQUM7QUFDMUUsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLDhCQUE4QixDQUFDOzs7SUFJM0QsT0FBUTtJQUNSLFFBQVM7SUFDVCxPQUFRO0lBQ1IsT0FBUTtJQUNSLFNBQVU7Ozs7Ozs7Ozs7O0FBS1osTUFBTSxPQUFnQixZQUFZOzs7Ozs7SUFTaEMsWUFBWSxRQUFtQixFQUFFLFFBQTBCLEVBQUUsTUFBNEI7UUFDdkYsSUFBSSxDQUFDLEtBQUssR0FBRyxRQUFRLENBQUM7UUFDdEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFFckIsSUFBSSxDQUFDLHdCQUF3QixHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLFNBQVM7Ozs7UUFBRSxDQUFDLENBQWdCLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsRUFBQyxDQUFDO0lBQzFILENBQUM7Ozs7SUFFRCxJQUFXLFdBQVc7UUFDcEIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQztJQUNsQyxDQUFDOzs7O0lBRUQsSUFBVyxZQUFZO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUM7SUFDbkMsQ0FBQzs7OztJQUlELElBQVcsT0FBTztRQUNoQixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdkIsQ0FBQzs7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QUFDLGFBQWEsR0FBRyxLQUFLLENBQUMsQ0FBQztZQUU1QyxJQUFJLFFBQVEsQ0FBQyxVQUFVLEVBQUU7Z0JBQ3ZCLE9BQU87YUFDUjtTQUNGO1FBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDbEMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUM3RCxDQUFDOzs7NkJBektBLFlBQVksU0FBQyxlQUFlO3NCQTBCNUIsS0FBSzs7OztJQTVCTiw4QkFBb0M7Ozs7O0lBQ3BDLDZCQUFnQzs7Ozs7SUFDaEMsc0NBQ21EOzs7OztJQUNuRCx3Q0FBd0M7Ozs7O0lBQ3hDLGdEQUE2Qzs7Ozs7SUFpQjdDLGdDQUFrQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7QWZ0ZXJWaWV3SW5pdCwgSW5wdXQsIE9uRGVzdHJveSwgUXVlcnlMaXN0LCBSZW5kZXJlcjIsIFZpZXdDaGlsZHJlbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7S2V5Q29kZX0gZnJvbSAnLi4vLi4vLi4vbWlzYy91dGlsL2ludGVybmFsJztcclxuaW1wb3J0IHtDYWxlbmRhckl0ZW0sIEZ1aUNhbGVuZGFySXRlbX0gZnJvbSAnLi4vZGlyZWN0aXZlcy9jYWxlbmRhci1pdGVtJztcclxuaW1wb3J0IHtDYWxlbmRhclNlcnZpY2V9IGZyb20gJy4uL3NlcnZpY2VzL2NhbGVuZGFyLnNlcnZpY2UnO1xyXG5pbXBvcnQge0NhbGVuZGFyUmFuZ2VTZXJ2aWNlfSBmcm9tICcuLi9zZXJ2aWNlcy9jYWxlbmRhci1yYW5nZS5zZXJ2aWNlJztcclxuXHJcbmV4cG9ydCBlbnVtIENhbGVuZGFyVmlld1R5cGUge1xyXG4gIFllYXIgPSAwLFxyXG4gIE1vbnRoID0gMSxcclxuICBEYXRlID0gMixcclxuICBIb3VyID0gMyxcclxuICBNaW51dGUgPSA0XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIENhbGVuZGFyVmlld1Jlc3VsdCA9IFtEYXRlLCBDYWxlbmRhclZpZXdUeXBlXTtcclxuXHJcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBDYWxlbmRhclZpZXcgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xyXG5cclxuICBwdWJsaWMgcmFuZ2VzOiBDYWxlbmRhclJhbmdlU2VydmljZTtcclxuICBwcml2YXRlIF90eXBlOiBDYWxlbmRhclZpZXdUeXBlO1xyXG4gIEBWaWV3Q2hpbGRyZW4oRnVpQ2FsZW5kYXJJdGVtKVxyXG4gIHByaXZhdGUgX3JlbmRlcmVkSXRlbXM6IFF1ZXJ5TGlzdDxGdWlDYWxlbmRhckl0ZW0+O1xyXG4gIHByaXZhdGUgX2hpZ2hsaWdodGVkSXRlbT86IENhbGVuZGFySXRlbTtcclxuICBwcml2YXRlIF9kb2N1bWVudEtleURvd25MaXN0ZW5lcjogKCkgPT4gdm9pZDtcclxuXHJcbiAgY29uc3RydWN0b3IocmVuZGVyZXI6IFJlbmRlcmVyMiwgdmlld1R5cGU6IENhbGVuZGFyVmlld1R5cGUsIHJhbmdlczogQ2FsZW5kYXJSYW5nZVNlcnZpY2UpIHtcclxuICAgIHRoaXMuX3R5cGUgPSB2aWV3VHlwZTtcclxuICAgIHRoaXMucmFuZ2VzID0gcmFuZ2VzO1xyXG5cclxuICAgIHRoaXMuX2RvY3VtZW50S2V5RG93bkxpc3RlbmVyID0gcmVuZGVyZXIubGlzdGVuKCdkb2N1bWVudCcsICdrZXlkb3duJywgKGU6IEtleWJvYXJkRXZlbnQpID0+IHRoaXMub25Eb2N1bWVudEtleURvd24oZSkpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldCBjdXJyZW50RGF0ZSgpOiBEYXRlIHtcclxuICAgIHJldHVybiB0aGlzLnNlcnZpY2UuY3VycmVudERhdGU7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0IHNlbGVjdGVkRGF0ZSgpOiBEYXRlIHwgdW5kZWZpbmVkIHtcclxuICAgIHJldHVybiB0aGlzLnNlcnZpY2Uuc2VsZWN0ZWREYXRlO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfc2VydmljZTogQ2FsZW5kYXJTZXJ2aWNlO1xyXG5cclxuICBwdWJsaWMgZ2V0IHNlcnZpY2UoKTogQ2FsZW5kYXJTZXJ2aWNlIHtcclxuICAgIHJldHVybiB0aGlzLl9zZXJ2aWNlO1xyXG4gIH1cclxuXHJcbiAgQElucHV0KClcclxuICBwdWJsaWMgc2V0IHNlcnZpY2Uoc2VydmljZTogQ2FsZW5kYXJTZXJ2aWNlKSB7XHJcbiAgICB0aGlzLl9zZXJ2aWNlID0gc2VydmljZTtcclxuICAgIHRoaXMucmFuZ2VzLmxvYWRTZXJ2aWNlKHNlcnZpY2UpO1xyXG5cclxuICAgIHRoaXMuc2VydmljZS5vbk1hbnVhbFVwZGF0ZSA9ICgpID0+IHtcclxuICAgICAgdGhpcy5yYW5nZXMucmVmcmVzaCgpO1xyXG5cclxuICAgICAgZGVsZXRlIHRoaXMuX2hpZ2hsaWdodGVkSXRlbTtcclxuICAgICAgdGhpcy5hdXRvSGlnaGxpZ2h0KCk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLy8gVGVtcGxhdGUgTWV0aG9kc1xyXG5cclxuICBwdWJsaWMgc2V0RGF0ZShpdGVtOiBDYWxlbmRhckl0ZW0pOiB2b2lkIHtcclxuICAgIHRoaXMuc2VydmljZS5jaGFuZ2VEYXRlKGl0ZW0uZGF0ZSwgdGhpcy5fdHlwZSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgem9vbU91dCgpOiB2b2lkIHtcclxuICAgIHRoaXMuc2VydmljZS56b29tT3V0KHRoaXMuX3R5cGUpO1xyXG4gIH1cclxuXHJcbiAgLy8gS2V5Ym9hcmQgQ29udHJvbFxyXG5cclxuICBwdWJsaWMgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5fcmVuZGVyZWRJdGVtcy5jaGFuZ2VzLnN1YnNjcmliZSgoKSA9PiB0aGlzLm9uUmVuZGVyZWRJdGVtc0NoYW5nZWQoKSk7XHJcbiAgICB0aGlzLm9uUmVuZGVyZWRJdGVtc0NoYW5nZWQoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIHRoaXMuX2RvY3VtZW50S2V5RG93bkxpc3RlbmVyKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG9uUmVuZGVyZWRJdGVtc0NoYW5nZWQoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9yZW5kZXJlZEl0ZW1zLmZvckVhY2goaSA9PlxyXG4gICAgICBpLm9uRm9jdXNzZWQuc3Vic2NyaWJlKChoYXNGb2N1czogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgIGlmIChoYXNGb2N1cykge1xyXG4gICAgICAgICAgdGhpcy5oaWdobGlnaHRJdGVtKGkuaXRlbSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KSk7XHJcblxyXG4gICAgdGhpcy5hdXRvSGlnaGxpZ2h0KCk7XHJcbiAgICB0aGlzLmhpZ2hsaWdodEl0ZW0odGhpcy5faGlnaGxpZ2h0ZWRJdGVtKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXV0b0hpZ2hsaWdodCgpOiB2b2lkIHtcclxuICAgIGxldCBkYXRlID0gdGhpcy5zZWxlY3RlZERhdGUgJiYgdGhpcy5yYW5nZXMuY3VycmVudC5jb250YWluc0RhdGUodGhpcy5zZWxlY3RlZERhdGUpID8gdGhpcy5zZWxlY3RlZERhdGUgOiB0aGlzLmN1cnJlbnREYXRlO1xyXG4gICAgaWYgKHRoaXMuX2hpZ2hsaWdodGVkSXRlbSAmJiB0aGlzLnJhbmdlcy5jdXJyZW50LmNvbnRhaW5zRGF0ZSh0aGlzLl9oaWdobGlnaHRlZEl0ZW0uZGF0ZSkpIHtcclxuICAgICAgZGF0ZSA9IHRoaXMuX2hpZ2hsaWdodGVkSXRlbS5kYXRlO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGluaXRpYWxseUhpZ2hsaWdodGVkID0gdGhpcy5yYW5nZXMuY3VycmVudC5pdGVtcy5maW5kKGkgPT4gdGhpcy5yYW5nZXMuZGF0ZUNvbXBhcmVyLmVxdWFsKGkuZGF0ZSwgZGF0ZSkpO1xyXG4gICAgaWYgKGluaXRpYWxseUhpZ2hsaWdodGVkICYmICFpbml0aWFsbHlIaWdobGlnaHRlZC5pc0Rpc2FibGVkKSB7XHJcbiAgICAgIHRoaXMuX2hpZ2hsaWdodGVkSXRlbSA9IGluaXRpYWxseUhpZ2hsaWdodGVkO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoaWdobGlnaHRJdGVtKGl0ZW06IENhbGVuZGFySXRlbSB8IHVuZGVmaW5lZCk6IHZvaWQge1xyXG4gICAgaWYgKGl0ZW0pIHtcclxuICAgICAgdGhpcy5fcmVuZGVyZWRJdGVtcy5mb3JFYWNoKGkgPT4gaS5oYXNGb2N1cyA9IGZhbHNlKTtcclxuICAgICAgY29uc3QgcmVuZGVyZWQgPSB0aGlzLl9yZW5kZXJlZEl0ZW1zLmZpbmQocmkgPT4gcmkuaXRlbSA9PT0gaXRlbSk7XHJcbiAgICAgIGlmIChyZW5kZXJlZCAmJiAhcmVuZGVyZWQuaGFzRm9jdXMpIHtcclxuICAgICAgICByZW5kZXJlZC5oYXNGb2N1cyA9IHRydWU7XHJcbiAgICAgICAgcmVuZGVyZWQuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLl9oaWdobGlnaHRlZEl0ZW0gPSBpdGVtO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBvbkRvY3VtZW50S2V5RG93bihlOiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5faGlnaGxpZ2h0ZWRJdGVtICYmIGUua2V5Q29kZSA9PT0gS2V5Q29kZS5FbnRlcikge1xyXG4gICAgICB0aGlzLnNldERhdGUodGhpcy5faGlnaGxpZ2h0ZWRJdGVtKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghdGhpcy5faGlnaGxpZ2h0ZWRJdGVtKSB7XHJcbiAgICAgIHRoaXMuYXV0b0hpZ2hsaWdodCgpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5yYW5nZXMuY3VycmVudC5maW5kSW5kZXgodGhpcy5faGlnaGxpZ2h0ZWRJdGVtKTtcclxuICAgIGxldCBpc01vdmluZ0ZvcndhcmQgPSB0cnVlO1xyXG4gICAgbGV0IGRlbHRhID0gMDtcclxuXHJcbiAgICBzd2l0Y2ggKGUua2V5Q29kZSkge1xyXG4gICAgICBjYXNlIEtleUNvZGUuUmlnaHQ6XHJcbiAgICAgICAgZGVsdGEgKz0gMTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSBLZXlDb2RlLkxlZnQ6XHJcbiAgICAgICAgZGVsdGEgLT0gMTtcclxuICAgICAgICBpc01vdmluZ0ZvcndhcmQgPSBmYWxzZTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSBLZXlDb2RlLkRvd246XHJcbiAgICAgICAgZGVsdGEgKz0gdGhpcy5yYW5nZXMuY29sdW1ucztcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSBLZXlDb2RlLlVwOlxyXG4gICAgICAgIGRlbHRhIC09IHRoaXMucmFuZ2VzLmNvbHVtbnM7XHJcbiAgICAgICAgaXNNb3ZpbmdGb3J3YXJkID0gZmFsc2U7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFN0b3AgdGhlc2Uga2V5cHJlc3NlcyBiZWluZyBjYXB0dXJlZCBlbHNld2hlcmUuXHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcblxyXG4gICAgbGV0IG5leHRJdGVtID0gdGhpcy5yYW5nZXMuY3VycmVudC5pdGVtc1tpbmRleCArIGRlbHRhXTtcclxuXHJcbiAgICBpZiAobmV4dEl0ZW0gJiYgbmV4dEl0ZW0uaXNEaXNhYmxlZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG5leHRJdGVtICYmICFuZXh0SXRlbS5pc091dHNpZGVSYW5nZSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5oaWdobGlnaHRJdGVtKG5leHRJdGVtKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAobmV4dEl0ZW0gJiYgbmV4dEl0ZW0uaXNPdXRzaWRlUmFuZ2UpIHtcclxuICAgICAgaWYgKGluZGV4ICsgZGVsdGEgPj0gdGhpcy5yYW5nZXMuY3VycmVudC5pblJhbmdlLmxlbmd0aCkge1xyXG4gICAgICAgIGlzTW92aW5nRm9yd2FyZCA9IHRydWU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAoIW5leHRJdGVtKSB7XHJcbiAgICAgIGxldCBhZGp1c3RlZEluZGV4ID0gdGhpcy5yYW5nZXMuY3VycmVudC5maW5kSW5kZXgodGhpcy5faGlnaGxpZ2h0ZWRJdGVtKTtcclxuXHJcbiAgICAgIGNvbnN0IG5leHRJdGVtcyA9IHRoaXMucmFuZ2VzLmNhbGMoaXNNb3ZpbmdGb3J3YXJkKS5pblJhbmdlO1xyXG5cclxuICAgICAgaWYgKGlzTW92aW5nRm9yd2FyZCkge1xyXG4gICAgICAgIGFkanVzdGVkSW5kZXggLT0gdGhpcy5yYW5nZXMuY3VycmVudC5pblJhbmdlLmxlbmd0aDtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBhZGp1c3RlZEluZGV4ICs9IG5leHRJdGVtcy5sZW5ndGg7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIG5leHRJdGVtID0gbmV4dEl0ZW1zW2FkanVzdGVkSW5kZXggKyBkZWx0YV07XHJcblxyXG4gICAgICBpZiAobmV4dEl0ZW0uaXNEaXNhYmxlZCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucmFuZ2VzLm1vdmUoaXNNb3ZpbmdGb3J3YXJkKTtcclxuICAgIHRoaXMuX2hpZ2hsaWdodGVkSXRlbSA9IHRoaXMucmFuZ2VzLmN1cnJlbnQuZmluZChuZXh0SXRlbSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==